name: Setup Neon Database

on:
  push:
    branches:
      - main

jobs:
  setup:
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create .env file from secrets
        run: |
          echo DATABASE_URL=${{ secrets.DATABASE_URL }} >> .env
          echo JWT_SECRET=${{ secrets.JWT_SECRET }} >> .env

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Generate Prisma Client
        run: pnpx prisma generate

      - name: Validate Environment Variables
        run: |
          if [ -z "${{ secrets.DATABASE_URL }}" ]; then
            echo "‚ùå DATABASE_URL is not set!"
            exit 1
          fi
          if [ -z "${{ secrets.JWT_SECRET }}" ]; then
            echo "‚ùå JWT_SECRET is not set!"
            exit 1
          fi
          echo "‚úÖ DATABASE_URL and JWT_SECRET are set correctly."

      - name: Show DATABASE_URL value
        run: |
          echo "Using DATABASE_URL:"
          echo "${{ secrets.DATABASE_URL }}"

      - name: Run Database Setup
        run: node scripts/complete-setup.js
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}

      - name: Deploy Application
        run: |
          echo "üöÄ Starting deployment..."
          pnpm run build
          echo "‚úÖ Application built successfully."
          echo "‚ÑπÔ∏è To start the application, run 'pnpm start'"